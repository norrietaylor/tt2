name: Triage Issue #13

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Add labels and triage comment to issue #13
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = 13;

            // Fetch current labels on issue #13
            const { data: issue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber,
            });

            const existingLabels = issue.labels.map(l => l.name);
            const labelsToAdd = ['plan', 'ai-generated'].filter(
              l => !existingLabels.includes(l)
            );

            // Add missing labels
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: labelsToAdd,
              });
              core.info(`Added labels to #${issueNumber}: ${labelsToAdd.join(', ')}`);
            } else {
              core.info(`Issue #${issueNumber} already has all required labels.`);
            }

            // Check if a triage comment already exists (idempotent)
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: issueNumber,
            });

            const alreadyCommented = comments.some(
              c =>
                c.user.login === 'github-actions[bot]' &&
                c.body.includes('Issue Triaged')
            );

            if (!alreadyCommented) {
              const childIssues = [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36]
                .map(n => `- #${n}`)
                .join('\n');

              const comment = `### ğŸ·ï¸ Issue Triaged

This planning request has been fulfilled. The high-level implementation plan was generated by the [Plan Command](https://github.com/norrietaylor/tt2/actions/runs/22474918502) workflow and broken into the following child issues:

${childIssues}

**Labels added**: \`plan\`, \`ai-generated\`

<details>
<summary><b>View Triage Details</b></summary>

#### Analysis
- **Issue type**: Planning request authored by the repository owner
- **Resolution**: Plan generated via the \`/plan\` command; 12 implementation issues (#25â€“#36) created covering all phases of the PRD
- **Status**: âœ… Closed as completed â€” plan work is fully captured in child issues

#### Traceability
Owner intent (#13) â†’ AI-generated plan issues (#25â€“#36) â†’ implementation PRs

</details>`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: comment,
              });
              core.info(`Added triage comment to #${issueNumber}`);
            } else {
              core.info(`Triage comment already present on #${issueNumber}, skipping.`);
            }
